<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruang Bersama</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        dark: "#0f172a", // Slate 900
                        darker: "#020617", // Slate 950
                        glass: "rgba(30, 41, 59, 0.7)", // Slate 800 alpha
                        primary: "#6366f1", // Indigo 500
                        secondary: "#d946ef" // Fuchsia 500
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            background-attachment: fixed;
            color: #e2e8f0;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
        }
        /* Inputs Dark Mode */
        input, select, textarea {
            background-color: #1e293b; color: white; border-color: #334155;
        }
        input:focus, select:focus, textarea:focus {
            background-color: #0f172a; border-color: #6366f1;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .loader {
            width: 24px; height: 24px; border: 3px solid #6366f1; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .status-badge { @apply px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm border; }
        .status-menunggu { @apply bg-yellow-900/30 text-yellow-400 border-yellow-700/50; }
        .status-proses { @apply bg-blue-900/30 text-blue-400 border-blue-700/50; }
        .status-selesai, .status-diterima, .status-sudah-dibalas { @apply bg-green-900/30 text-green-400 border-green-700/50; }
        .status-ditolak { @apply bg-red-900/30 text-red-400 border-red-700/50; }
        
        /* Chat Bubble Styles */
        .chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; font-size: 0.9rem; position: relative; word-wrap: break-word; }
        .chat-left { background: #334155; color: #f1f5f9; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-right { background: #4f46e5; color: white; align-self: flex-end; border-bottom-right-radius: 2px; margin-left: auto; }
        .chat-meta { font-size: 0.65rem; opacity: 0.7; margin-top: 4px; display: block; }
    </style>
</head>
<body class="antialiased overflow-hidden font-sans selection:bg-indigo-500 selection:text-white">

    <!-- ALERT SYSTEM -->
    <div id="custom-alert" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm fade-in">
        <div class="glass-panel rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-100 bg-[#1e293b]">
            <div id="alert-header" class="h-1.5 bg-indigo-500"></div>
            <div class="p-6 text-center">
                <div id="alert-icon" class="text-5xl mb-4 text-indigo-400"><i class="fa-solid fa-circle-info"></i></div>
                <h3 id="alert-title" class="text-xl font-bold mb-2 text-white">Perhatian</h3>
                <p id="alert-msg" class="text-slate-400 text-sm mb-6 leading-relaxed">Pesan alert disini.</p>
                <div class="flex gap-3 justify-center" id="alert-actions">
                    <button onclick="closeAlert()" class="bg-slate-700 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-600 transition">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="view-login" class="flex items-center justify-center min-h-screen p-4 relative overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-[128px] opacity-20 animate-pulse"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-indigo-600 rounded-full mix-blend-multiply filter blur-[128px] opacity-20 animate-pulse"></div>

        <div class="glass-panel w-full max-w-md p-8 rounded-3xl shadow-2xl relative z-10 fade-in border-t-4 border-indigo-500">
            <div class="text-center mb-8">
                <!-- LOGO SEKOLAH -->
                <img src="https://lh3.googleusercontent.com/u/0/d/1Wr_uC9C32tjzN19PZXLsk3tyBNrzO1wy" alt="Logo Aplikasi" class="w-25 h-24 object-contain mx-auto mb-4 drop-shadow-xl hover:scale-105 transition duration-300 rounded-full bg-white/10 p-2">
                
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 tracking-tight">RUANG BERSAMA</h1>
                <p class="text-slate-400 text-sm mt-2 font-medium tracking-wide">Wujudkan Sekolah Nyaman, Aman, dan Transparan</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-5">
                <div class="relative group">
                    <i class="fa-solid fa-user absolute left-4 top-3.5 text-slate-500 group-focus-within:text-indigo-400 transition"></i>
                    <input type="text" id="login-user" class="w-full pl-12 pr-4 py-3.5 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm font-medium" placeholder="Username / NISN / NIP" required>
                </div>
                <div class="relative group">
                    <i class="fa-solid fa-lock absolute left-4 top-3.5 text-slate-500 group-focus-within:text-indigo-400 transition"></i>
                    <input type="password" id="login-pass" class="w-full pl-12 pr-12 py-3.5 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm font-medium" placeholder="Kata Sandi" required>
                    <button type="button" onclick="togglePass('login-pass', this)" class="absolute right-4 top-3.5 text-slate-500 hover:text-indigo-400"><i class="fa-solid fa-eye"></i></button>
                </div>
                <button type="submit" id="btn-login" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-indigo-500/30 hover:scale-[1.02] transition flex justify-center items-center gap-2">
                    <span>Masuk Aplikasi</span>
                    <div class="loader hidden w-5 h-5 border-white border-t-transparent" id="login-loader"></div>
                </button>
            </form>

            <div class="mt-6 text-center border-t border-slate-700/50 pt-4">
                <button onclick="showAppInfo()" class="text-xs text-indigo-400 hover:text-indigo-300 font-bold flex items-center justify-center gap-2 mx-auto transition">
                    <i class="fa-solid fa-circle-info"></i> Tentang Aplikasi
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="view-app" class="hidden h-screen flex relative overflow-hidden">
        
        <!-- Mobile Header -->
        <div class="md:hidden absolute top-0 left-0 right-0 h-16 glass-panel z-40 flex items-center justify-between px-6 shadow-sm bg-[#0f172a]/90">
            <div class="flex items-center gap-2 text-indigo-400 font-bold text-lg"><i class="fa-solid fa-school"></i> Ruang Bersama</div>
            <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 shadow-sm text-slate-300 hover:text-white"><i class="fa-solid fa-bars text-xl"></i></button>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="bg-[#0f172a]/95 backdrop-blur-xl w-72 h-full absolute md:static top-0 -left-72 md:left-0 z-50 transition-all duration-300 shadow-2xl md:shadow-none border-r border-slate-800 flex flex-col justify-between">
            <div class="flex flex-col h-full">
                <!-- User Profile -->
                <div class="p-6 pb-2 mt-16 md:mt-0">
                    <div class="glass-card p-5 rounded-2xl flex flex-col items-center text-center bg-gradient-to-b from-slate-800 to-transparent border-none shadow-sm">
                        <div class="relative">
                            <img id="nav-foto" src="" class="w-20 h-20 rounded-full object-cover border-4 border-slate-700 shadow-md bg-slate-800">
                            <div class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 border-2 border-slate-800 rounded-full"></div>
                        </div>
                        <h2 id="nav-nama" class="font-bold text-white mt-3 truncate w-full text-sm">User Name</h2>
                        <span id="nav-role" class="text-[10px] tracking-widest text-indigo-300 bg-indigo-900/50 px-3 py-1 rounded-full uppercase font-bold mt-1 border border-indigo-700/30">Role</span>
                    </div>
                </div>

                <!-- Nav Menu -->
                <nav class="flex-1 overflow-y-auto px-4 py-4 space-y-1.5 custom-scrollbar">
                    <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Menu Utama</p>
                    <button onclick="navTo('dashboard')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-indigo-400 font-medium transition flex items-center gap-3 group">
                        <span class="w-8 h-8 rounded-lg bg-slate-800 text-indigo-500 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition"><i class="fa-solid fa-house text-xs"></i></span> Dashboard
                    </button>
                    <button onclick="navTo('profil')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-indigo-400 font-medium transition flex items-center gap-3 group">
                        <span class="w-8 h-8 rounded-lg bg-slate-800 text-blue-500 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition"><i class="fa-solid fa-user text-xs"></i></span> Profil Saya
                    </button>

                    <div id="menu-guru-wrapper" class="hidden">
                        <div class="my-4 border-t border-slate-800"></div>
                        <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Administrasi Guru</p>
                        <button onclick="handleMenuAction('prestasi')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-green-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-green-500 flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition"><i class="fa-solid fa-trophy text-xs"></i></span> Data Prestasi
                        </button>
                        <button onclick="handleMenuAction('pelanggaran')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-red-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-red-500 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition"><i class="fa-solid fa-triangle-exclamation text-xs"></i></span> Data Pelanggaran
                        </button>
                        <button onclick="handleMenuAction('bullying')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-orange-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-orange-500 flex items-center justify-center group-hover:bg-orange-600 group-hover:text-white transition"><i class="fa-solid fa-inbox text-xs"></i></span> Laporan Masuk
                        </button>
                        <button onclick="handleMenuAction('curhat')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-purple-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-purple-500 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition"><i class="fa-solid fa-comments text-xs"></i></span> Pesan Curhat
                        </button>
                        <button onclick="handleMenuAction('booking')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-pink-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-pink-500 flex items-center justify-center group-hover:bg-pink-600 group-hover:text-white transition"><i class="fa-solid fa-calendar-check text-xs"></i></span> Jadwal Konseling
                        </button>
                    </div>

                    <div id="menu-siswa-wrapper" class="hidden">
                        <div class="my-4 border-t border-slate-800"></div>
                        <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Layanan Siswa</p>
                        <button onclick="handleMenuAction('prestasi')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-green-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-green-500 flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition"><i class="fa-solid fa-medal text-xs"></i></span> Data Prestasiku
                        </button>
                        <button onclick="handleMenuAction('pelanggaran')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-red-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-red-500 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition"><i class="fa-solid fa-circle-exclamation text-xs"></i></span> Pelanggaranku
                        </button>
                        <button onclick="handleMenuAction('bullying')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-orange-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-orange-500 flex items-center justify-center group-hover:bg-orange-600 group-hover:text-white transition"><i class="fa-solid fa-shield-cat text-xs"></i></span> Lapor Bullying
                        </button>
                        <button onclick="handleMenuAction('curhat')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-purple-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-purple-500 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition"><i class="fa-solid fa-heart text-xs"></i></span> Curhat Online
                        </button>
                        <button onclick="handleMenuAction('booking')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-indigo-900/50 text-slate-400 hover:text-pink-400 font-medium transition flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-lg bg-slate-800 text-pink-500 flex items-center justify-center group-hover:bg-pink-600 group-hover:text-white transition"><i class="fa-solid fa-calendar-plus text-xs"></i></span> Janji Konseling
                        </button>
                    </div>
                </nav>

                <div class="p-4 border-t border-slate-800 bg-[#020617]/30">
                    <button onclick="doLogout()" class="w-full bg-slate-800 border border-slate-700 text-slate-400 py-2.5 rounded-xl hover:bg-red-900/50 hover:text-red-400 hover:border-red-800 transition font-bold text-sm flex items-center justify-center gap-2 shadow-sm">
                        <i class="fa-solid fa-right-from-bracket"></i> Keluar
                    </button>
                </div>
            </div>
            <!-- Overlay for mobile -->
            <button onclick="toggleSidebar()" class="md:hidden absolute top-4 right-[-50px] w-10 h-10 bg-slate-800 shadow-md rounded-r-lg flex items-center justify-center text-slate-400"><i class="fa-solid fa-xmark"></i></button>
        </aside>

        <!-- Main Content (LAYOUT WIDER: Max-w-7xl) -->
        <main class="flex-1 h-full overflow-y-auto p-4 pt-20 md:p-8 scroll-smooth flex flex-col" onclick="closeSidebarMobile()">
            
            <!-- Dashboard -->
            <div id="page-dashboard" class="space-y-6 w-full max-w-7xl mx-auto fade-in flex-grow">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Dashboard</h2>
                        <p class="text-slate-400">Selamat datang, <span id="dash-nama" class="font-bold text-indigo-400">Sahabat</span>!</p>
                    </div>
                    <div class="glass-panel px-5 py-2.5 rounded-xl flex items-center gap-3 shadow-sm bg-slate-800/50">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span id="clock-display" class="font-mono font-bold text-slate-300 tracking-wide">--:--</span>
                    </div>
                </header>

                <!-- STATS DASHBOARD (DINAMIS) -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Stat 1: Status Sistem -->
                    <div class="glass-card p-6 rounded-2xl border-b-4 border-indigo-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-widest">Database</h3>
                                <p id="stat-total-siswa" class="text-2xl font-bold text-white mt-1">...</p>
                                <p class="text-xs text-indigo-300 mt-2"><i class="fa-solid fa-user-graduate"></i> Siswa Terdaftar</p>
                            </div>
                            <div class="p-4 bg-indigo-900/50 rounded-2xl text-indigo-400"><i class="fa-solid fa-users text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Stat 2: Laporan (Bullying) -->
                    <div class="glass-card p-6 rounded-2xl border-b-4 border-orange-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-widest">Laporan</h3>
                                <p id="stat-laporan" class="text-2xl font-bold text-white mt-1">...</p>
                                <p class="text-xs text-orange-300 mt-2"><i class="fa-solid fa-inbox"></i> Pengaduan Masuk</p>
                            </div>
                            <div class="p-4 bg-orange-900/50 rounded-2xl text-orange-400"><i class="fa-solid fa-shield-cat text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Stat 3: Konseling -->
                    <div class="glass-card p-6 rounded-2xl border-b-4 border-pink-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-widest">Konseling</h3>
                                <p id="stat-konseling" class="text-2xl font-bold text-white mt-1">...</p>
                                <p class="text-xs text-pink-300 mt-2"><i class="fa-solid fa-clock"></i> Menunggu Konfirmasi</p>
                            </div>
                            <div class="p-4 bg-pink-900/50 rounded-2xl text-pink-400"><i class="fa-solid fa-calendar-check text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Stat 4: Prestasi (Positif) -->
                    <div class="glass-card p-6 rounded-2xl border-b-4 border-green-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-widest">Prestasi</h3>
                                <p id="stat-prestasi" class="text-2xl font-bold text-white mt-1">...</p>
                                <p class="text-xs text-green-300 mt-2"><i class="fa-solid fa-medal"></i> Tercatat Sistem</p>
                            </div>
                            <div class="p-4 bg-green-900/50 rounded-2xl text-green-400"><i class="fa-solid fa-trophy text-2xl"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Banner Hari Ini -->
                <div class="glass-card p-6 rounded-2xl bg-gradient-to-r from-indigo-900/40 to-purple-900/40 border border-slate-700/50 flex flex-col md:flex-row items-center justify-between gap-4">
                     <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-2xl text-yellow-400 shadow-lg">ðŸ“…</div>
                        <div>
                            <h3 class="font-bold text-lg text-white">Hari ini: <span id="date-display">-</span></h3>
                            <p class="text-slate-400 text-sm">Semoga harimu menyenangkan dan penuh semangat belajar!</p>
                        </div>
                     </div>
                     <button onclick="refreshDashboardStats()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2 border border-slate-600">
                        <i class="fa-solid fa-rotate-right"></i> Refresh Data
                     </button>
                </div>

                <!-- Quick Actions Grid -->
                <div class="mt-4">
                    <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-bolt text-yellow-400"></i> Akses Cepat</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="navTo('profil')" class="glass-card p-4 rounded-xl hover:bg-slate-700/50 text-left transition group">
                            <div class="w-10 h-10 rounded-full bg-blue-900/50 text-blue-400 flex items-center justify-center mb-3 group-hover:scale-110 transition"><i class="fa-solid fa-user-pen"></i></div>
                            <span class="text-sm font-bold text-slate-300 group-hover:text-white">Edit Profil</span>
                        </button>
                        <button onclick="handleMenuAction('curhat')" class="glass-card p-4 rounded-xl hover:bg-slate-700/50 text-left transition group">
                            <div class="w-10 h-10 rounded-full bg-purple-900/50 text-purple-400 flex items-center justify-center mb-3 group-hover:scale-110 transition"><i class="fa-solid fa-comments"></i></div>
                            <span class="text-sm font-bold text-slate-300 group-hover:text-white">Buka Curhat</span>
                        </button>
                        <button onclick="handleMenuAction('booking')" class="glass-card p-4 rounded-xl hover:bg-slate-700/50 text-left transition group">
                            <div class="w-10 h-10 rounded-full bg-pink-900/50 text-pink-400 flex items-center justify-center mb-3 group-hover:scale-110 transition"><i class="fa-solid fa-calendar-check"></i></div>
                            <span class="text-sm font-bold text-slate-300 group-hover:text-white">Cek Jadwal</span>
                        </button>
                        <button onclick="doLogout()" class="glass-card p-4 rounded-xl hover:bg-red-900/20 text-left transition group border-red-900/30">
                            <div class="w-10 h-10 rounded-full bg-red-900/50 text-red-400 flex items-center justify-center mb-3 group-hover:scale-110 transition"><i class="fa-solid fa-power-off"></i></div>
                            <span class="text-sm font-bold text-slate-300 group-hover:text-red-400">Keluar</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profil View -->
            <div id="page-profil" class="hidden w-full max-w-4xl mx-auto fade-in pb-10 flex-grow">
                <div class="glass-panel p-8 rounded-3xl shadow-xl relative overflow-hidden bg-slate-800/80">
                    <div class="absolute top-0 left-0 right-0 h-32 bg-gradient-to-r from-indigo-600 to-purple-800 opacity-80"></div>
                    <div class="relative z-10 flex flex-col items-center -mt-10 mb-8">
                        <div class="relative group">
                            <img id="edit-foto-preview" src="" class="w-32 h-32 rounded-full object-cover border-4 border-slate-800 shadow-xl bg-slate-700">
                            <label for="edit-foto-input" class="absolute bottom-1 right-1 bg-slate-700 p-2.5 rounded-full shadow-md cursor-pointer hover:bg-slate-600 text-indigo-400 transition hover:scale-110 border border-slate-600">
                                <i class="fa-solid fa-camera"></i>
                            </label>
                            <input type="file" id="edit-foto-input" accept="image/*" class="hidden">
                        </div>
                        <h2 class="text-2xl font-bold mt-4 text-white" id="prof-display-name">RUANG BERSAMA</h2>
                        <p class="text-sm text-slate-400">Ketuk ikon kamera untuk ubah foto</p>
                    </div>
                    <form onsubmit="handleUpdateProfile(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="text-xs font-bold text-slate-500 mb-1 block">USERNAME</label><input type="text" id="prof-user" class="w-full p-3.5 rounded-xl font-bold transition cursor-not-allowed opacity-75" readonly></div>
                            <div><label class="text-xs font-bold text-slate-500 mb-1 block">ID UNIK (NIP/NISN)</label><input type="text" id="prof-id" class="w-full p-3.5 rounded-xl font-bold cursor-not-allowed opacity-75" readonly></div>
                            <div class="md:col-span-2"><label class="text-xs font-bold text-slate-500 mb-1 block">NAMA LENGKAP</label><input type="text" id="prof-nama" class="w-full p-3.5 rounded-xl cursor-not-allowed opacity-75" readonly></div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">PASSWORD BARU</label>
                                <div class="relative"><input type="password" id="prof-pass" class="w-full p-3.5 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"><button type="button" onclick="togglePass('prof-pass', this)" class="absolute right-4 top-4 text-slate-400 hover:text-indigo-400"><i class="fa-solid fa-eye"></i></button></div>
                            </div>
                            <div><label class="text-xs font-bold text-slate-500 mb-1 block">JENIS KELAMIN</label><select id="prof-kelamin" class="w-full p-3.5 rounded-xl"><option>Laki-laki</option><option>Perempuan</option></select></div>
                            <div class="md:col-span-2"><label class="text-xs font-bold text-slate-500 mb-1 block">NO. WHATSAPP</label><input type="text" id="prof-wa" class="w-full p-3.5 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                        </div>
                        <button type="submit" id="btn-save-profile" class="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 hover:shadow-indigo-500/30 transition transform active:scale-95">Simpan Perubahan</button>
                    </form>
                </div>
            </div>
            
            <!-- List View (WIDER LAYOUT: Max-w-7xl) -->
            <div id="page-list" class="hidden w-full max-w-7xl mx-auto fade-in pb-20 flex-grow">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-slate-900/50 p-4 rounded-2xl border border-slate-800 sticky top-0 z-10 backdrop-blur-md">
                    <div class="flex items-center gap-3">
                        <div id="list-icon" class="w-10 h-10 rounded-full bg-indigo-900/50 flex items-center justify-center text-indigo-400"><i class="fa-solid fa-list"></i></div>
                        <div>
                            <h2 id="list-title" class="text-xl font-bold text-white">Riwayat</h2>
                            <p class="text-slate-400 text-xs">Data terkini dari server</p>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center w-full md:w-auto justify-end">
                         <button onclick="refreshList()" class="w-9 h-9 flex items-center justify-center rounded-lg bg-slate-800 hover:bg-indigo-600 text-slate-400 hover:text-white transition border border-slate-700" title="Segarkan Data"><i class="fa-solid fa-rotate-right"></i></button>
                         <div id="action-btn-container"></div>
                         <button onclick="navTo('dashboard')" class="text-sm bg-slate-800 px-4 py-2 rounded-lg shadow-sm text-slate-300 hover:text-white font-bold border border-slate-700 hover:bg-slate-700 transition">Kembali</button>
                    </div>
                </div>
                
                <div id="list-content" class="space-y-5 min-h-[300px]"></div>
                
                <!-- Pagination -->
                <div id="pagination-controls" class="flex justify-center items-center gap-4 mt-8 hidden">
                    <button onclick="changePage(-1)" id="btn-prev" class="bg-slate-800 text-slate-400 px-4 py-2 rounded-lg disabled:opacity-50 hover:bg-slate-700 transition font-bold text-sm">Sebelumnya</button>
                    <span id="page-info" class="text-slate-400 text-sm font-mono">Page 1</span>
                    <button onclick="changePage(1)" id="btn-next" class="bg-slate-800 text-slate-400 px-4 py-2 rounded-lg disabled:opacity-50 hover:bg-slate-700 transition font-bold text-sm">Selanjutnya</button>
                </div>
            </div>

            <!-- FOOTER -->
            <footer class="mt-auto py-6 text-center text-slate-500 text-xs border-t border-slate-800/50">
                <p>&copy; <span id="footer-year">2026</span> <strong>Ruang Bersama</strong>. Dibuat dengan <i class="fa-solid fa-heart text-pink-500 mx-1"></i> oleh <span class="font-bold text-indigo-400">Muhammad Hasratul</span>.</p>
            </footer>

        </main>
    </div>

    <!-- MODAL FORM -->
    <div id="modal-container" class="hidden fixed inset-0 z-[80] flex items-end md:items-center justify-center p-0 md:p-4 bg-black/80 backdrop-blur-sm fade-in">
        <div class="bg-slate-900 w-full md:max-w-lg md:rounded-3xl rounded-t-3xl shadow-2xl max-h-[90vh] flex flex-col transform transition-all border border-slate-700">
            <div class="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-900 md:rounded-t-3xl rounded-t-3xl sticky top-0 z-10">
                <h3 id="modal-title" class="font-bold text-xl text-white">Form</h3>
                <button type="button" onclick="closeModal()" class="w-9 h-9 rounded-full bg-slate-800 hover:bg-red-900/50 hover:text-red-400 flex items-center justify-center transition text-slate-400 border border-slate-700"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar bg-slate-900" id="modal-content">
                <!-- Form Injected via JS -->
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbw3O-2666Nh1S9ekCudGTsJpOz4RgqnXf2a-EvASdwTk8h1SQyGce0N3KWd-dlLsYfC/exec"; 

        let currentUser = null;
        let referensi = { prestasi: [], pelanggaran: [] };
        let siswaList = []; 
        let guruList = [];
        
        // Pagination Globals
        let globalData = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let currentType = '';

        // Security Helper (Anti XSS)
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        window.onload = () => {
            const savedUser = localStorage.getItem('rb_user');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }
            startClock();
            document.getElementById('footer-year').innerText = new Date().getFullYear();
        };

        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock-display').innerText = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                if(document.getElementById('date-display')) document.getElementById('date-display').innerText = now.toLocaleDateString('id-ID', options);
            };
            update(); setInterval(update, 1000);
        }

        function resolveImg(data) {
            if (!data || data === 'undefined' || data === '') return 'https://via.placeholder.com/150/1e293b/FFFFFF?text=Foto';
            let id = data;
            if (data.includes('drive.google.com') && data.includes('id=')) {
                const match = data.match(/id=([^&]+)/);
                if (match && match[1]) id = match[1];
            } else if (data.startsWith('http') && !data.includes('drive.google.com')) { return data; }
            return `https://lh3.googleusercontent.com/d/${id}`;
        }

        function getSiswaDetail(nisn) {
            const s = siswaList.find(item => item.nisn == nisn);
            if (s) return s;
            return { nama: nisn, kelas: '-', kelamin: '-', foto: '' }; 
        }

        function showAlert(title, message, type = 'info', onConfirm = null) {
            const el = document.getElementById('custom-alert');
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = message;
            const icon = document.getElementById('alert-icon');
            const acts = document.getElementById('alert-actions');
            let color = 'text-indigo-400';
            
            if(type === 'success') { color = 'text-green-400'; icon.innerHTML = '<i class="fa-solid fa-circle-check"></i>'; }
            else if(type === 'error') { color = 'text-red-400'; icon.innerHTML = '<i class="fa-solid fa-circle-xmark"></i>'; }
            else if(type === 'loading') { color = 'text-blue-400'; icon.innerHTML = '<div class="loader"></div>'; }
            else { icon.innerHTML = '<i class="fa-solid fa-circle-info"></i>'; }
            icon.className = `text-5xl mb-4 ${color}`;

            if (type === 'confirm') {
                acts.innerHTML = `
                    <button onclick="closeAlert()" class="bg-slate-700 text-slate-300 px-5 py-2 rounded-xl font-bold hover:bg-slate-600">Batal</button>
                    <button id="alert-yes" class="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold hover:bg-indigo-700 shadow-lg">Ya, Lanjutkan</button>
                `;
                document.getElementById('alert-yes').onclick = () => { closeAlert(); if(onConfirm) onConfirm(); };
            } else if (type === 'loading') {
                acts.innerHTML = ''; // No buttons while loading
            } else {
                acts.innerHTML = `<button onclick="closeAlert()" class="bg-slate-700 text-white px-8 py-2 rounded-xl font-bold hover:bg-slate-600">Oke</button>`;
            }
            el.classList.remove('hidden');
        }
        function closeAlert() { document.getElementById('custom-alert').classList.add('hidden'); }
        function togglePass(id, btn) { const i = document.getElementById(id); const ic = btn.querySelector('i'); if(i.type==="password"){i.type="text";ic.className="fa-solid fa-eye-slash";}else{i.type="password";ic.className="fa-solid fa-eye";} }
        function toggleSidebar() { const sb = document.getElementById('sidebar'); sb.classList.toggle('-left-72'); sb.classList.toggle('left-0'); }
        function closeSidebarMobile() { if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('-left-72'); document.getElementById('sidebar').classList.remove('left-0'); } }
        function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
        function showAppInfo() { showAlert('Tentang Ruang Bersama', 'Aplikasi ini dibuat untuk menciptakan lingkungan sekolah yang aman, nyaman, dan transparan. Dikembangkan dengan semangat kolaborasi antara Guru dan Siswa.', 'info'); }

        async function handleLogin(e) {
            e.preventDefault(); const btn = document.getElementById('btn-login'); const loader = document.getElementById('login-loader');
            const user = document.getElementById('login-user').value; const pass = document.getElementById('login-pass').value;
            btn.disabled = true; loader.classList.remove('hidden');
            try {
                const res = await callAPI({ action: 'login', username: user, password: pass });
                if(res.status === 'success') {
                    currentUser = { ...res.data, role: res.role };
                    localStorage.setItem('rb_user', JSON.stringify(currentUser));
                    showApp();
                } else { showAlert('Gagal', res.message, 'error'); }
            } catch(err) { showAlert('Error', "Koneksi gagal.", 'error'); }
            btn.disabled = false; loader.classList.add('hidden');
        }
        function doLogout() { showAlert('Keluar?', 'Yakin ingin logout?', 'confirm', () => { localStorage.removeItem('rb_user'); location.reload(); }); }

        function showApp() {
            document.getElementById('view-login').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden');
            document.getElementById('nav-nama').innerText = currentUser.nama; document.getElementById('dash-nama').innerText = currentUser.nama;
            document.getElementById('nav-role').innerText = currentUser.role.toUpperCase();
            document.getElementById('nav-foto').src = resolveImg(currentUser.foto);
            document.getElementById('menu-guru-wrapper').classList.add('hidden'); document.getElementById('menu-siswa-wrapper').classList.add('hidden');
            
            // Initial Data Load
            loadSiswaList().then(() => refreshDashboardStats()); // Update stats after siswa loaded
            loadGuruList();

            if(currentUser.role === 'guru') { document.getElementById('menu-guru-wrapper').classList.remove('hidden'); loadReferensi(); } 
            else { document.getElementById('menu-siswa-wrapper').classList.remove('hidden'); }
            navTo('dashboard');
        }

        // --- DASHBOARD LOGIC (NEW FEATURE) ---
        async function refreshDashboardStats() {
            // Animasi Loading Dummy
            ['stat-total-siswa', 'stat-laporan', 'stat-konseling', 'stat-prestasi'].forEach(id => {
                document.getElementById(id).innerHTML = '<span class="text-sm opacity-50">...</span>';
            });

            // 1. Total Siswa (Local Count if loaded)
            if(siswaList.length > 0) {
                document.getElementById('stat-total-siswa').innerText = siswaList.length;
            }

            // 2. Fetch Real Data for counts
            // Kita panggil API untuk masing-masing tipe secara parallel biar cepat
            try {
                // Tambahkan parameter "nama: currentUser.nama" di belakangnya
				const pLaporan = callAPI({ action: 'getData', type: 'bullying', role: currentUser.role, id_unik: currentUser.id_unik, nama: currentUser.nama });
				const pKonseling = callAPI({ action: 'getData', type: 'booking', role: currentUser.role, id_unik: currentUser.id_unik, nama: currentUser.nama });
				const pPrestasi = callAPI({ action: 'getData', type: 'prestasi', role: currentUser.role, id_unik: currentUser.id_unik, nama: currentUser.nama });

                const [rLaporan, rKonseling, rPrestasi] = await Promise.all([pLaporan, pKonseling, pPrestasi]);

                if(rLaporan.status === 'success') document.getElementById('stat-laporan').innerText = rLaporan.data.length;
                else document.getElementById('stat-laporan').innerText = "0";

                if(rKonseling.status === 'success') {
                    // Filter yang statusnya 'Menunggu'
                    const pending = rKonseling.data.filter(d => d[6].includes('Menunggu'));
                    document.getElementById('stat-konseling').innerText = pending.length;
                } else document.getElementById('stat-konseling').innerText = "0";

                if(rPrestasi.status === 'success') document.getElementById('stat-prestasi').innerText = rPrestasi.data.length;
                else document.getElementById('stat-prestasi').innerText = "0";

            } catch(e) {
                console.log("Stats error", e);
            }
        }

        function navTo(page) {
            closeSidebarMobile();
            ['dashboard', 'profil', 'list'].forEach(id => document.getElementById('page-' + id).classList.add('hidden'));
            document.getElementById('page-' + page).classList.remove('hidden');
            if(page === 'profil') loadProfilData();
            if(page === 'dashboard') refreshDashboardStats(); // Refresh stats when clicking home
        }

        function handleMenuAction(type) { closeSidebarMobile(); openList(type); }
        function refreshList() { if(currentType) openList(currentType); }

        // --- LIST VIEW WITH PAGINATION & CHAT ---
        async function openList(type) {
            navTo('list');
            currentType = type;
            const container = document.getElementById('list-content');
            const title = document.getElementById('list-title');
            const icon = document.getElementById('list-icon');
            const actionDiv = document.getElementById('action-btn-container');
            const pagnDiv = document.getElementById('pagination-controls');
            
            let t = 'Data'; let btn = ''; let icn = '<i class="fa-solid fa-list"></i>';

            if(type === 'prestasi') { t = 'Data Prestasi'; icn = '<i class="fa-solid fa-trophy"></i>'; if(currentUser.role === 'guru') btn = `<button onclick="openModal('lapor-prestasi')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-700 flex gap-2 items-center"><i class="fa-solid fa-plus"></i> Catat Baru</button>`; } 
            else if(type === 'pelanggaran') { t = 'Data Pelanggaran'; icn = '<i class="fa-solid fa-triangle-exclamation"></i>'; if(currentUser.role === 'guru') btn = `<button onclick="openModal('lapor-pelanggaran')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-red-700 flex gap-2 items-center"><i class="fa-solid fa-plus"></i> Catat Baru</button>`; } 
            else if(type === 'bullying') { t = 'Laporan Bullying'; icn = '<i class="fa-solid fa-shield-cat"></i>'; if(currentUser.role === 'siswa') btn = `<button onclick="openModal('bullying')" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-orange-700 flex gap-2 items-center"><i class="fa-solid fa-bullhorn"></i> Buat Laporan</button>`; } 
            else if(type === 'curhat') { t = 'Curhat Online'; icn = '<i class="fa-solid fa-comments"></i>'; if(currentUser.role === 'siswa') btn = `<button onclick="openModal('curhat')" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-purple-700 flex gap-2 items-center"><i class="fa-solid fa-pen"></i> Tulis Pesan</button>`; } 
            else if(type === 'booking') { t = 'Jadwal Konseling'; icn = '<i class="fa-solid fa-calendar-check"></i>'; if(currentUser.role === 'siswa') btn = `<button onclick="openModal('booking')" class="bg-pink-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-pink-700 flex gap-2 items-center"><i class="fa-solid fa-calendar-plus"></i> Ajukan Jadwal</button>`; }

            title.innerText = t; icon.innerHTML = icn; actionDiv.innerHTML = btn;
            container.innerHTML = '<div class="flex justify-center p-20"><div class="loader"></div></div>';
            pagnDiv.classList.add('hidden');

            try {
                // Tambahkan parameter "nama: currentUser.nama"
				const res = await callAPI({ action: 'getData', type: type, role: currentUser.role, id_unik: currentUser.id_unik, nama: currentUser.nama });
                if(res.status === 'success') {
                    globalData = res.data;
                    currentPage = 1;
                    renderList();
                } else {
                    container.innerHTML = `<div class="glass-card p-10 text-center text-slate-500 flex flex-col items-center"><i class="fa-solid fa-folder-open text-4xl mb-3 opacity-30"></i><p>Belum ada data.</p></div>`;
                }
            } catch(e) { container.innerHTML = `<div class="text-red-400 text-center font-bold">Gagal memuat data.</div>`; }
        }

        function renderList() {
            const container = document.getElementById('list-content');
            const pagnDiv = document.getElementById('pagination-controls');
            
            if(globalData.length === 0) {
                container.innerHTML = `<div class="glass-card p-10 text-center text-slate-500 flex flex-col items-center"><i class="fa-solid fa-folder-open text-4xl mb-3 opacity-30"></i><p>Belum ada data.</p></div>`;
                pagnDiv.classList.add('hidden');
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = globalData.slice(start, end);
            let html = '';

            // RENDER DATA
            if(currentType === 'prestasi' || currentType === 'pelanggaran') {
                html = pageData.map(d => {
                    const siswa = getSiswaDetail(d[3]);
                    const color = d[4]==='Prestasi' ? 'border-green-500' : 'border-red-500';
                    return `
                    <div class="glass-card p-6 rounded-2xl border-l-4 ${color} bg-slate-800 flex flex-col md:flex-row gap-5 items-start">
                        <img src="${resolveImg(siswa.foto)}" class="w-14 h-14 rounded-full object-cover bg-slate-700 border-2 border-slate-600 shadow-sm flex-shrink-0">
                        <div class="flex-1 w-full">
                            <div class="flex justify-between">
                                <div><h4 class="font-bold text-lg text-white">${siswa.nama}</h4><p class="text-xs text-slate-400">${siswa.kelas || 'Siswa'} â€¢ ${d[1]}</p></div>
                                ${d[7]?`<button onclick="window.open('${resolveImg(d[7])}')" class="text-xs bg-indigo-900/50 text-indigo-400 px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-800 transition border border-indigo-800 flex items-center gap-2"><i class="fa-solid fa-image"></i> Lihat Bukti Foto</button>`:''}
                            </div>
                            <div class="mt-3 p-3 bg-slate-900/50 rounded-xl border border-slate-700"><p class="text-xs font-bold text-slate-500 uppercase mb-1">${d[5]}</p><p class="text-slate-300 text-sm">${escapeHtml(d[6])}</p></div>
                        </div>
                    </div>`;
                }).join('');
            } else if(currentType === 'bullying') {
                html = pageData.map(d => {
                    const isAnonim = d[2] === 'Anonim';
                    const siswa = isAnonim ? { nama: "Hamba Allah", kelas: "Rahasia", foto: "" } : getSiswaDetail(d[2]);
                    const avatar = isAnonim ? `https://ui-avatars.com/api/?name=Anonim&background=random` : resolveImg(siswa.foto);
                    let st = d[5]; let bg = 'bg-yellow-900/30 text-yellow-400 border-yellow-700/50';
                    if(st==='Proses') bg='bg-blue-900/30 text-blue-400 border-blue-700/50';
                    if(st==='Selesai') bg='bg-green-900/30 text-green-400 border-green-700/50';
                    
                    let act = '';
                    if(currentUser.role === 'guru') {
                        act = `<div class="mt-4 pt-3 border-t border-slate-700 flex gap-2 items-center"><input type="text" id="resp-${d[0]}" placeholder="Tanggapan..." class="flex-1 bg-slate-900 border-slate-600 rounded px-2 py-1 text-sm"><button onclick="handleGuruAction('updateStatusLaporan', '${d[0]}', 'Proses', document.getElementById('resp-${d[0]}').value)" class="text-xs bg-blue-900/50 text-blue-400 px-3 py-1 rounded border border-blue-800 hover:bg-blue-900">Proses</button><button onclick="handleGuruAction('updateStatusLaporan', '${d[0]}', 'Selesai', document.getElementById('resp-${d[0]}').value)" class="text-xs bg-green-900/50 text-green-400 px-3 py-1 rounded border border-green-800 hover:bg-green-900">Selesai</button></div>`;
                    }
                    return `
                    <div class="glass-card p-6 rounded-2xl border-l-4 border-orange-500 bg-slate-800">
                        <div class="flex justify-between mb-4"><div class="flex gap-4 items-center"><img src="${avatar}" class="w-12 h-12 rounded-full"><div class="text-white font-bold">${siswa.nama}<p class="text-xs text-slate-400 font-normal">${siswa.kelas} â€¢ ${d[1]}</p></div></div><span class="px-2 py-1 rounded text-xs font-bold border ${bg}">${st}</span></div>
                        <div class="bg-orange-900/20 p-4 rounded-xl border border-orange-900/50 text-slate-300 text-sm italic">"${escapeHtml(d[3])}"</div>
                        ${d[6]&&d[6]!=='-'?`<div class="mt-2 text-xs text-indigo-400 bg-slate-900 p-2 rounded"><strong>Guru:</strong> ${escapeHtml(d[6])}</div>`:''}
                        ${d[4]?`<button onclick="window.open('${resolveImg(d[4])}')" class="mt-4 text-xs bg-slate-700 px-3 py-2 rounded text-slate-300 hover:bg-slate-600 border border-slate-600 flex items-center gap-2 w-fit"><i class="fa-solid fa-paperclip"></i> Lihat Bukti Foto</button>`:''}
                        ${act}
                    </div>`;
                }).join('');
            } else if(currentType === 'curhat') {
                html = pageData.map(d => {
                    const siswa = getSiswaDetail(d[2]);
                    const chats = [];
                    // Pesan Awal (Root Message)
                    chats.push({ sender: siswa.nama, text: d[4], time: d[1], type: 'left' }); 
                    
                    // JSON Compatible Logic for Histories
                    let replies = [];
                    // Try parsing JSON first (New format)
                    try {
                        if(d[6] && d[6].startsWith('[')) {
                            replies = JSON.parse(d[6]);
                        } else if(d[6]) {
                            // Fallback to split string (Old format)
                            const raw = d[6].split('|||');
                            raw.forEach(r => {
                                if(r.includes(':')) {
                                    const parts = r.split(':');
                                    const name = parts[0].replace('[','').replace(']','').trim();
                                    const msg = parts.slice(1).join(':').trim();
                                    replies.push({ sender: name, text: msg, time: '' });
                                } else {
                                    replies.push({ sender: 'Guru', text: r, time: d[7] || '' });
                                }
                            });
                        }
                    } catch(e) { console.log("Chat parse error", e); }

                    // Process display
                    replies.forEach(r => {
                         const type = (r.sender === currentUser.nama) ? 'right' : 'left'; 
                         chats.push({ sender: r.sender, text: r.text, time: r.time, type: type });
                    });

                    let chatHtml = chats.map(c => `
                        <div class="chat-bubble ${c.type === 'right' ? 'chat-right' : 'chat-left'}">
                            <div class="font-bold text-[10px] opacity-75 mb-1">${c.sender}</div>
                            ${escapeHtml(c.text)}
                            ${c.time ? `<span class="chat-meta">${c.time}</span>` : ''}
                        </div>
                    `).join('');

                    return `
                    <div class="glass-card p-5 rounded-2xl border-l-4 border-purple-500 bg-slate-800 mb-4">
                        <div class="flex justify-between mb-3 border-b border-slate-700 pb-2">
                            <span class="text-xs font-bold text-purple-400">Topik: Curhat ke ${d[3]}</span>
                            <span class="text-[10px] text-slate-500">ID: ${d[0]}</span>
                        </div>
                        <div class="flex gap-4 items-start">
                            <img src="${resolveImg(siswa.foto)}" class="w-10 h-10 rounded-full bg-slate-700">
                            <div class="flex-1">
                                <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700 mb-3 max-h-60 overflow-y-auto custom-scrollbar">
                                    ${chatHtml}
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="reply-${d[0]}" class="flex-1 bg-slate-900 border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="Ketik balasan...">
                                    <!-- Pass the RAW history string to the handler -->
                                    <button onclick="handleReply('${d[0]}')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700"><i class="fa-solid fa-paper-plane"></i></button>
                                    <div id="history-raw-${d[0]}" class="hidden">${escapeHtml(d[6] || '[]')}</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } else if(currentType === 'booking') {
                html = pageData.map(d => {
                    const siswa = getSiswaDetail(d[2]);
                    let st = d[6]; let bg = 'bg-yellow-900/30 text-yellow-400 border-yellow-700/50';
                    if(st==='Diterima'||st==='Selesai') bg='bg-green-900/30 text-green-400 border-green-700/50';
                    if(st==='Ditolak') bg='bg-red-900/30 text-red-400 border-red-700/50';
                    let act = '';
                    if(currentUser.role === 'guru') act = `<div class="mt-3 pt-3 border-t border-slate-700 flex gap-2 justify-end"><input id="bk-${d[0]}" placeholder="Catatan..." class="bg-slate-900 border-slate-600 rounded px-2 py-1 text-sm flex-1"><button onclick="handleGuruAction('updateBooking','${d[0]}','Diterima',document.getElementById('bk-${d[0]}').value)" class="text-xs bg-green-600 text-white px-3 py-1 rounded">Terima</button><button onclick="handleGuruAction('updateBooking','${d[0]}','Ditolak',document.getElementById('bk-${d[0]}').value)" class="text-xs bg-red-600 text-white px-3 py-1 rounded">Tolak</button></div>`;
                    return `
                    <div class="glass-card p-0 rounded-2xl bg-slate-800 overflow-hidden border border-slate-700">
                        <div class="p-5">
                            <div class="flex justify-between mb-3"><div class="flex gap-3 items-center"><img src="${resolveImg(siswa.foto)}" class="w-10 h-10 rounded-full"><div class="text-white font-bold text-sm">${siswa.nama}<p class="text-xs text-slate-400">${siswa.kelas}</p></div></div><span class="px-2 py-1 rounded text-xs border font-bold ${bg}">${st}</span></div>
                            <div class="grid grid-cols-2 gap-2 text-sm text-slate-300"><div><span class="text-xs text-slate-500 block">WAKTU</span>${d[4]}</div><div><span class="text-xs text-slate-500 block">TOPIK</span>${escapeHtml(d[5])}</div></div>
                            ${d[7]&&d[7]!=='-'?`<div class="mt-2 text-xs bg-slate-900 p-2 rounded text-indigo-300">Note: ${escapeHtml(d[7])}</div>`:''}
                            ${act}
                        </div>
                    </div>`;
                }).join('');
            }

            container.innerHTML = `<div class="space-y-4 fade-in">${html}</div>`;
            
            // PAGINATION CONTROLS
            pagnDiv.classList.remove('hidden');
            document.getElementById('page-info').innerText = `Halaman ${currentPage}`;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = end >= globalData.length;
        }

        function changePage(dir) {
            currentPage += dir;
            renderList();
        }

        // --- INTERACTIVE ACTIONS ---
        // New: Handle Reply using JSON Structure for Safety
        async function handleReply(id) {
            const input = document.getElementById(`reply-${id}`);
            const msg = input.value;
            if(!msg) return;

            // Retrieve current history from hidden div
            const rawHistory = document.getElementById(`history-raw-${id}`).innerText;
            let historyObj = [];
            
            // Parse existing
            try {
                if(rawHistory.startsWith('[')) historyObj = JSON.parse(rawHistory);
                else if(rawHistory) {
                     // Migrate old string format to Object on the fly
                     const raw = rawHistory.split('|||');
                     raw.forEach(r => {
                         if(r.includes(':')) {
                            const parts = r.split(':');
                            historyObj.push({ sender: parts[0].replace('[','').replace(']','').trim(), text: parts.slice(1).join(':').trim(), time: '' });
                         } else historyObj.push({ sender: 'Guru', text: r, time: '' });
                     });
                }
            } catch(e) {}

            // Add new message
            const newMsg = {
                sender: currentUser.nama,
                text: msg,
                time: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})
            };
            historyObj.push(newMsg);

            // Convert back to string (JSON Stringify)
            const updatedHistory = JSON.stringify(historyObj);
            
            // Show Loading
            showAlert('Mengirim...', 'Sedang mengirim pesan...', 'loading');
            
            const res = await callAPI({
                action: 'balasCurhat',
                id_curhat: id,
                nama_guru: currentUser.nama, 
                balasan: updatedHistory 
            });
            
            closeAlert();
            if(res.status === 'success') {
                openList(currentType); 
            } else {
                showAlert('Gagal', res.message, 'error');
            }
        }

        async function handleGuruAction(action, id, val1, val2) {
            if(!val1) return alert("Status wajib dipilih");
            showAlert('Menyimpan...', 'Sedang memproses data...', 'loading');
            const res = await callAPI({ 
                action: action, 
                id_laporan: id, id_booking: id, 
                status: val1, tanggapan: val2 || '-', catatan: val2 || '-' 
            });
            closeAlert();
            if(res.status === 'success') {
                showAlert('Berhasil', res.message, 'success');
                openList(currentType);
            } else {
                showAlert('Gagal', res.message, 'error');
            }
        }

        // --- DATA LOADERS ---
        async function loadSiswaList() { try { const r = await callAPI({ action: 'getSiswaList' }); if(r.status==='success') siswaList=r.data; } catch(e){} }
        async function loadGuruList() { try { const r = await callAPI({ action: 'getGuruList' }); if(r.status==='success') guruList=r.data; } catch(e){} }
        function onSiswaSelect(e) { const s = getSiswaDetail(e.value); document.getElementById('info-nama').value=s.nama; document.getElementById('info-kelas').value=s.kelas; document.getElementById('info-kelamin').value=s.kelamin; }
        async function loadReferensi() { const r = await callAPI({ action: 'getReferensi' }); if(r.status==='success') referensi=r; }

        function openModal(type) {
            const m = document.getElementById('modal-container'); m.classList.remove('hidden');
            document.getElementById('modal-content').innerHTML = '<div class="flex justify-center p-10"><div class="loader"></div></div>';
            let html = '';
            
            if(type.includes('lapor')) {
                const isPres = type.includes('prestasi');
                const cats = isPres ? referensi.prestasi : referensi.pelanggaran;
                let opts = '<option value="">-- Pilih Siswa --</option>'; siswaList.forEach(s=>opts+=`<option value="${s.nisn}">${s.nama} (${s.kelas})</option>`);
                html = `
                <form onsubmit="submitLaporan(event, '${isPres?'Prestasi':'Pelanggaran'}')" class="space-y-4">
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <label class="text-xs text-slate-400 font-bold">CARI SISWA</label>
                        <select name="nisn" onchange="onSiswaSelect(this)" class="w-full p-2 bg-slate-700 rounded mt-1 border-slate-600">${opts}</select>
                        <div class="flex gap-2 mt-2">
                            <input id="info-nama" class="w-1/2 p-2 bg-slate-900 rounded text-xs" readonly placeholder="Nama">
                            <input id="info-kelas" class="w-1/4 p-2 bg-slate-900 rounded text-xs" readonly placeholder="Kelas">
                            <input id="info-kelamin" class="w-1/4 p-2 bg-slate-900 rounded text-xs" readonly placeholder="L/P">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold">KATEGORI</label>
                        <select name="kategori" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700">${cats.map(c=>`<option>${c}</option>`)}</select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold">DETAIL</label>
                        <textarea name="catatan" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700" rows="3"></textarea>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-xl border-dashed border border-slate-600">
                        <label class="text-xs text-indigo-400 font-bold">BUKTI</label>
                        <input type="file" name="bukti" accept="image/*" class="w-full text-sm text-slate-400 mt-1">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 p-3 rounded-xl text-white font-bold hover:bg-indigo-700">Simpan Data</button>
                </form>`;
            } else if(type === 'bullying') {
                html = `
                <form onsubmit="submitBullying(event)" class="space-y-4">
                    <div class="bg-orange-900/30 p-3 rounded border border-orange-800/50 text-orange-400 text-xs">Identitas bisa disamarkan (Anonim).</div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold">IDENTITAS</label>
                        <select name="identitas" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700"><option value="${currentUser.id_unik}">Nama Saya</option><option value="Anonim">Anonim</option></select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold">KRONOLOGI</label>
                        <textarea name="kronologi" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700" rows="4"></textarea>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-xl border-dashed border border-slate-600">
                        <input type="file" name="bukti" class="w-full text-sm text-slate-400">
                    </div>
                    <button class="w-full bg-orange-600 p-3 rounded-xl text-white font-bold hover:bg-orange-700">Kirim Laporan</button>
                </form>`;
            } else if(type === 'curhat') {
                let opts = '<option value="Semua Guru">Semua Guru</option>'; guruList.forEach(g=>opts+=`<option value="${g.nama}">${g.nama} (${g.tugas})</option>`);
                html = `
                <form onsubmit="submitCurhat(event)" class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 font-bold">TUJUAN</label>
                        <select name="target" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700">${opts}</select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold">PESAN</label>
                        <textarea name="pesan" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700 focus:border-purple-500" rows="5"></textarea>
                    </div>
                    <button class="w-full bg-purple-600 p-3 rounded-xl text-white font-bold hover:bg-purple-700">Kirim Pesan</button>
                </form>`;
            } else if(type === 'booking') {
                let opts = '<option value="">-- Bebas --</option>'; guruList.forEach(g=>opts+=`<option value="${g.nama}">${g.nama}</option>`);
                html = `
                <form onsubmit="submitBooking(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs text-slate-400 font-bold">NAMA</label><input value="${currentUser.nama}" class="w-full p-3 bg-slate-900 rounded-xl border-none text-sm" readonly></div>
                        <div><label class="text-xs text-slate-400 font-bold">KELAS</label><input value="Auto" class="w-full p-3 bg-slate-900 rounded-xl border-none text-sm" readonly></div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold">GURU</label>
                        <select name="guru" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700">${opts}</select>
                    </div>
                    <div><label class="text-xs text-slate-400 font-bold">TOPIK</label><input name="topik" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs text-slate-400 font-bold">WAKTU</label><input type="datetime-local" name="jadwal" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700 text-sm"></div>
                        <div><label class="text-xs text-slate-400 font-bold">LOKASI</label><select name="lokasi" class="w-full p-3 bg-slate-800 rounded-xl border-slate-700 text-sm"><option>Ruang BK</option><option>Kantor</option><option>Taman</option></select></div>
                    </div>
                    <button class="w-full bg-pink-600 p-3 rounded-xl text-white font-bold hover:bg-pink-700">Ajukan</button>
                </form>`;
            }
            document.getElementById('modal-content').innerHTML = html;
        }

        // --- SUBMIT FUNCTIONS (REVISED: READABLE) ---

        async function submitLaporan(e, jenis) {
            e.preventDefault();
            const f = e.target;
            showAlert('Menyimpan...', 'Mohon tunggu sebentar', 'loading');
            
            let buktiId = "";
            if (f.bukti.files.length > 0) {
                const compressed = await compressImage(f.bukti.files[0]);
                const upload = await callAPI({
                    action: 'uploadFoto',
                    base64: compressed.split(',')[1],
                    filename: `Bukti_${jenis}.jpg`
                });
                if (upload.status === 'success') buktiId = upload.fileUrl || upload.fileId;
            }

            const res = await callAPI({
                action: 'kirimLaporan',
                nip_pelapor: currentUser.id_unik,
                nisn_siswa: f.nisn.value,
                jenis_laporan: jenis,
                kategori: f.kategori.value,
                catatan: f.catatan.value,
                bukti_id: buktiId
            });

            closeModal();
            closeAlert();
            if (res.status === 'success') {
                showAlert('Berhasil', res.message, 'success');
                refreshDashboardStats(); // Update stats
                openList(jenis.toLowerCase());
            } else {
                showAlert('Gagal', res.message, 'error');
            }
        }

        async function submitBullying(e) {
            e.preventDefault();
            const f = e.target;
            showAlert('Mengirim...', 'Laporan sedang dikirim aman...', 'loading');
            
            let buktiId = "";
            if (f.bukti.files.length > 0) {
                const compressed = await compressImage(f.bukti.files[0]);
                const upload = await callAPI({
                    action: 'uploadFoto',
                    base64: compressed.split(',')[1],
                    filename: 'Bully.jpg'
                });
                if (upload.status === 'success') buktiId = upload.fileUrl || upload.fileId;
            }

            const res = await callAPI({
                action: 'kirimBullying',
                pelapor: f.identitas.value,
                kronologi: f.kronologi.value,
                bukti_id: buktiId
            });

            closeModal();
            closeAlert();
            if (res.status === 'success') {
                showAlert('Terkirim', 'Laporan diterima sekolah.', 'success');
                refreshDashboardStats(); // Update stats
                openList('bullying');
            } else {
                showAlert('Gagal', res.message, 'error');
            }
        }

        async function submitCurhat(e) {
            e.preventDefault();
            const f = e.target;
            showAlert('Mengirim...', 'Pesan sedang dikirim...', 'loading');
            
            const res = await callAPI({
                action: 'curhatOnline',
                nisn: currentUser.id_unik,
                target_guru: f.target.value,
                pesan: f.pesan.value
            });

            closeModal();
            closeAlert();
            if (res.status === 'success') {
                showAlert('Terkirim', 'Pesan berhasil dikirim.', 'success');
                refreshDashboardStats(); // Update stats
                openList('curhat');
            } else {
                showAlert('Gagal', res.message, 'error');
            }
        }

        async function submitBooking(e) {
            e.preventDefault();
            const f = e.target;
            showAlert('Mengirim...', 'Jadwal sedang diajukan...', 'loading');
            
            const d = new Date(f.jadwal.value);
            const jadwalStr = d.toLocaleDateString('id-ID') + ' ' + d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            const topikFull = `[${f.lokasi.value}] ${f.topik.value}`;
            
            const res = await callAPI({
                action: 'bookingKonseling',
                nisn: currentUser.id_unik,
                guru_target: f.guru.value || "-",
                jadwal_minta: jadwalStr,
                topik: topikFull
            });

            closeModal();
            closeAlert();
            if (res.status === 'success') {
                showAlert('Diajukan', 'Menunggu konfirmasi guru.', 'success');
                refreshDashboardStats(); // Update stats
                openList('booking');
            } else {
                showAlert('Gagal', res.message, 'error');
            }
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-profile');
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            let fotoId = currentUser.foto;
            const fileInput = document.getElementById('edit-foto-input');
            
            if (fileInput.files.length > 0) {
                const compressed = await compressImage(fileInput.files[0]);
                const upload = await callAPI({
                    action: 'uploadFoto',
                    base64: compressed.split(',')[1],
                    filename: currentUser.username + '_p.jpg'
                });
                if (upload.status === 'success') fotoId = upload.fileUrl || upload.fileId;
            }

            const res = await callAPI({
                action: 'updateProfile',
                role: currentUser.role,
                username: currentUser.username,
                password: document.getElementById('prof-pass').value,
                kelamin: document.getElementById('prof-kelamin').value,
                wa: document.getElementById('prof-wa').value,
                foto: fotoId
            });

            btn.innerText = "Simpan Perubahan";
            btn.disabled = false;

            if (res.status === 'success') {
                currentUser.foto = fotoId;
                localStorage.setItem('rb_user', JSON.stringify(currentUser));
                showAlert('Sukses', 'Profil diperbarui', 'success');
                showApp();
            } else {
                showAlert('Gagal', res.message, 'error');
            }
        }

        function loadProfilData() {
            callAPI({ action: 'getProfile', username: currentUser.username, role: currentUser.role })
                .then(r => {
                    if(r.status === 'success') {
                        const d = r.data;
                        document.getElementById('prof-nama').value = d.nama;
                        document.getElementById('prof-user').value = d.username;
                        document.getElementById('prof-id').value = d.id_unik;
                        document.getElementById('prof-kelamin').value = d.kelamin || "Laki-laki";
                        document.getElementById('prof-wa').value = d.wa;
                        document.getElementById('edit-foto-preview').src = resolveImg(d.foto);
                    }
                });
        }

        async function callAPI(data) {
            try {
                const r = await fetch(API_URL, {
                    method: "POST",
                    mode: "cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(data)
                });
                return await r.json();
            } catch (e) {
                return { status: 'error', message: 'Koneksi Gagal' };
            }
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = e => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > 1000) { h *= 1000 / w; w = 1000; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        let quality = 0.9;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);
                        while (dataUrl.length > 200 * 1024 && quality > 0.1) {
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        resolve(dataUrl);
                    }
                };
                reader.onerror = e => reject(e);
            });
        }
    </script>
</body>
</html>
